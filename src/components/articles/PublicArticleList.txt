<template>
  <div id="main-content" class="w-full h-dvh">
    <div class="container m-auto flex w-full h-dvh md:px-8 lg:px-36 2xl:px-52">
      <Tabs value="0" class="flex-1 mx-auto h-full">
        <TabList>
          <Tab value="0">Home</Tab>
          <Tab value="1">Following</Tab>
          <Tab value="2">Shared</Tab>
        </TabList>
        <TabPanels class="h-full p-0">
          <TabPanel value="0" class="h-full p-0">
            <ScrollPanel class="w-full h-full pb-16">
              <Panel
                v-for="article in articlesFeed"
                :key="article.id"
                class="border relative p-2 rounded-none border-t-0 border-r-0 border-l-0"
              >
                <template #header>
                  <div class="flex items-center gap-2">
                    <router-link
                      class="text-sm font-bold flex items-center gap-2"
                    >
                      <Avatar
                        v-if="article.author.image"
                        :image="article.author.image"
                        shape="circle"
                      />

                      <Avatar
                        v-else
                        icon="pi pi-user text-white text-xs"
                        shape="circle"
                        class="bg-[#1B4D3E]"
                      />
                      <span class="font-bold"
                        >{{ article.author.firstName }}
                        {{ article.author.lastName }}</span
                      >
                    </router-link>

                    <Button
                      v-if="article.author.isFollowed"
                      class="text-xs"
                      rounded
                      text
                      label="Following"
                      @click="removeAuthorFollower(article.author)"
                    />
                    <Button
                      v-else-if="
                        !article.author.isFollowed && article.author.id !== id
                      "
                      class="text-xs"
                      rounded
                      text
                      label="Follow"
                      @click="addAuthorFollower(article.author)"
                    />
                  </div>
                </template>
                <template #icons>
                  <Button
                    icon="pi pi-ellipsis-h"
                    severity="secondary"
                    rounded
                    text
                    @click="toggle"
                  />
                  <Menu ref="menu" id="config_menu" :model="items" popup />
                </template>
                <div class="">
                  <Card
                    pt:body:class="flex-1 p-0 m-auto"
                    class="shadow-none rounded-none items-start justify-between overflow-hidden flex-row-reverse w-full gap-4"
                  >
                    <!-- Text Content -->
                    <template #content>
                      <div class="flex flex-row w-full">
                        <div class="basis-3/4">
                          <router-link
                            class="w-full"
                            :to="{
                              name: 'public-article-detail',
                              params: { title: article.title },
                            }"
                            @click="handleArticleStore(article)"
                          >
                            <h3 class="font-black text-xl md:text-2xl">
                              {{ truncateText(article.title) }}
                            </h3>

                            <p class="text-lg">
                              {{ truncateText(article.description) }}
                            </p>
                          </router-link>

                          <div class="mt-4 flex items-center w-full">
                            <router-link
                              class="flex items-center gap-4"
                              :to="{
                                name: 'public-article-detail',
                                params: { title: article.title },
                              }"
                              @click="handleArticleStore(article)"
                            >
                              <div class="flex gap-1 items-center">
                                <span
                                  class="text-surface-500 text-sm font-normal dark:text-surface-400"
                                  >{{
                                    handleDateFormat(
                                      article.createdAt,
                                      "MMM DD"
                                    )
                                  }}</span
                                >
                              </div>

                              <div
                                class="flex gap-1 items-enter"
                                v-tooltip.top="`${article.likes} likes`"
                              >
                                <svg
                                  xmlns="http://www.w3.org/2000/svg"
                                  width="16"
                                  height="16"
                                  fill="none"
                                  aria-labelledby="clap-filled-static-desc"
                                  viewBox="0 0 16 16"
                                  class="mt-[0.1rem]"
                                >
                                  <desc id="clap-filled-static-desc">
                                    A clap icon
                                  </desc>
                                  <path
                                    fill="#6B6B6B"
                                    fill-rule="evenodd"
                                    d="m3.672 10.167 2.138 2.14h-.002c1.726 1.722 4.337 2.436 5.96.81 1.472-1.45 1.806-3.68.76-5.388l-1.815-3.484c-.353-.524-.849-1.22-1.337-.958-.49.261 0 1.56 0 1.56l.78 1.932L6.43 2.866c-.837-.958-1.467-1.108-1.928-.647-.33.33-.266.856.477 1.598.501.503 1.888 1.957 1.888 1.957.17.174.083.485-.093.655a.56.56 0 0 1-.34.163.43.43 0 0 1-.317-.135s-2.4-2.469-2.803-2.87c-.344-.346-.803-.54-1.194-.15-.408.406-.273 1.065.11 1.447.345.346 2.31 2.297 2.685 2.67l.062.06c.17.175.269.628.093.8-.193.188-.453.33-.678.273a.9.9 0 0 1-.446-.273S2.501 6.84 1.892 6.23c-.407-.406-.899-.333-1.229 0-.525.524.263 1.28 1.73 2.691.384.368.814.781 1.279 1.246m8.472-7.219c.372-.29.95-.28 1.303.244V3.19l1.563 3.006.036.074c.885 1.87.346 4.093-.512 5.159l-.035.044c-.211.264-.344.43-.74.61 1.382-1.855.963-3.478-.248-5.456L11.943 3.88l-.002-.037c-.017-.3-.039-.71.203-.895"
                                    clip-rule="evenodd"
                                  ></path>
                                </svg>
                                <span class="text-sm">{{ article.likes }}</span>
                              </div>

                              <div
                                class="flex gap-1 items-center"
                                v-tooltip.top="
                                  `${article.totalComments} comments`
                                "
                              >
                                <span class="pi pi-comments text-sm"></span>
                                <span class="text-sm">{{
                                  article.totalComments
                                }}</span>
                              </div>
                            </router-link>

                            <div class="ml-auto w-32 flex justify-center">
                              <Button
                                v-if="article.isSaved"
                                v-tooltip.top="'Saved'"
                                class="text-sm"
                                icon="pi pi-bookmark-fill"
                                severity="secondary"
                                variant="text"
                                rounded
                                aria-label="Bookmark"
                                @click="
                                  removeArticleFromReadingList(article.id)
                                "
                              />

                              <Button
                                v-else
                                v-tooltip.top="'Save'"
                                class="text-sm"
                                icon="pi pi-bookmark"
                                severity="secondary"
                                variant="text"
                                rounded
                                aria-label="Bookmark"
                                @click="addArticleToReadingList(article.id)"
                              />
                            </div>
                          </div>
                        </div>

                        <!-- Image -->
                        <div class="basis-1/4 max-h-24">
                          <router-link
                            class="w-full"
                            :to="{
                              name: 'public-article-detail',
                              params: { title: article.title },
                            }"
                            @click="handleArticleStore(article)"
                          >
                            <img
                              v-if="article.image"
                              :src="article.image"
                              class="w-full h-full object-cover"
                            />
                            <img
                              v-else
                              src="../../assets/images/pexels-vlada-karpovich-4452120.jpg"
                              alt="Mock Negotiation"
                              class="w-full h-full object-cover bas"
                            />
                          </router-link>
                        </div>
                      </div>
                    </template>
                  </Card>
                </div>
              </Panel>

              <Divider type="dashed" />

              <InfiniteLoading @infinite="load" />
            </ScrollPanel>
          </TabPanel>

          <TabPanel value="1">
            <p class="m-0">Coming soon!</p>
          </TabPanel>

          <TabPanel value="2">
            <p class="m-0">Coming soon!</p>
          </TabPanel>
        </TabPanels>
      </Tabs>

      <Divider layout="vertical" />

      <div class="w-72 h-full mx-auto">
        <ScrollPanel class="w-full h-full pb-16 pr-1">
          <!-- RECOMMENDED TOPICS -->
          <div class="flex flex-col gap-2">
            <div class="px-2 pt-6 pb-4">
              <h3 class="font-bold">Recommended Topics</h3>
            </div>
            <div class="card flex flex-wrap gap-2">
              <router-link
                v-for="topic in recommendedTopics"
                :key="topic.id"
                :to="{
                  name: 'tag-detail',
                  params: { name: topic.name },
                }"
              >
                <Chip class="text-sm" :label="topic.name" />
              </router-link>
            </div>
            <div>
              <router-link>
                <Button
                  v-if="totalRecommendedTopics"
                  label="See more topics"
                  severity="secondary"
                  variant="text"
                  class="text-xs font-semibold"
                  rounded
                />
              </router-link>
            </div>
          </div>

          <!-- WHO TO FOLLOW -->
          <div class="flex flex-col gap-2">
            <div class="px-2 pt-6">
              <h3 class="font-bold">Who to follow</h3>
            </div>

            <div
              v-for="author in recommendedAuthors"
              :key="author.id"
              class="w-full flex items-start gap-2 pr-2"
            >
              <router-link>
                <Panel
                  class="border-0 py-2"
                  pt:header:class="px-2 py-1"
                  pt:content:class="px-2 py-1"
                  pt:footer:class="px-2 py-1"
                >
                  <template #header>
                    <div class="flex items-center gap-2">
                      <Avatar
                        v-if="author.image"
                        :image="author.image"
                        shape="circle"
                      />

                      <Avatar
                        v-else
                        icon="pi pi-user text-white text-xs"
                        shape="circle"
                        class="bg-[#1B4D3E]"
                      />
                      <span class="font-bold text-sm"
                        >{{ author.firstName }} {{ author.lastName }}</span
                      >
                    </div>
                  </template>

                  <p class="m-0 text-sm w-[11rem]">
                    {{ truncateText(author.biography) }}
                  </p>
                </Panel>
              </router-link>
              <div class="pt-4 ml-auto">
                <Button
                  v-if="author.isFollowed"
                  class="text-xs"
                  severity="contrast"
                  variant="outlined"
                  rounded
                  label="Following"
                  @click="removeAuthorFollower(author)"
                />

                <Button
                  v-else
                  class="text-xs"
                  severity="contrast"
                  variant="outlined"
                  rounded
                  label="Follow"
                  @click="addAuthorFollower(author)"
                />
              </div>
            </div>

            <router-link>
              <Button
                v-if="totalRecommendedAuthors"
                label="See more suggestions"
                severity="secondary"
                variant="text"
                class="text-xs font-semibold"
                rounded
              />
            </router-link>
          </div>

          <!-- YOUR READING LIST -->
          <div>
            <div class="px-2 pt-6 pb-2">
              <h3 class="font-bold">Your reading list</h3>
            </div>

            <Panel
              class="border-0 py-2"
              pt:header:class="px-2 py-1"
              pt:content:class="px-2 py-1"
              pt:footer:class="px-2 py-1"
              v-for="list in userReadingList"
              :key="list.id"
            >
              <template #header>
                <div class="flex items-center gap-2">
                  <Avatar
                    v-if="list.author.image"
                    :image="list.author.image"
                    shape="circle"
                    size="small"
                    class="w-7 h-7"
                  />

                  <Avatar
                    v-else
                    icon="pi pi-user text-white text-xs"
                    size="small"
                    shape="circle"
                    class="bg-[#1B4D3E] w-7 h-7"
                  />
                  <span class="font-bold text-xs"
                    >{{ list.author.firstName }}
                    {{ list.author.lastName }}</span
                  >
                </div>
              </template>
              <template #footer>
                <router-link>
                  <div
                    class="flex flex-wrap items-center justify-between gap-4"
                  >
                    <span
                      class="text-surface-500 dark:text-surface-400 text-xs font-normal"
                      >{{ handleDateFormat(list.createdAt, "MMM DD") }}</span
                    >
                  </div>
                </router-link>
              </template>
              <router-link>
                <p class="m-0 font-black">
                  {{ truncateText(list.title) }}
                </p>
              </router-link>
            </Panel>

            <div>
              <router-link>
                <Button
                  v-if="totalReadingList > 4"
                  severity="secondary"
                  variant="text"
                  class="text-xs font-semibold"
                  rounded
                >
                  <span>See all ({{ totalReadingList }})</span>
                </Button>
              </router-link>
            </div>
          </div>

          <!-- AUTHORS YOU ARE FOLLOWING -->
          <div>
            <div class="flex items-center gap-2 px-2 pt-6 pb-2">
              <i class="pi pi-users"></i>
              <h3 class="font-bold">Following</h3>
            </div>
            <div class="card flex flex-col gap-2 px-2">
              <div v-for="author in followedAuthors" :key="author.id">
                <div class="flex items-center gap-2">
                  <Avatar
                    v-if="author.image"
                    :image="author.image"
                    shape="circle"
                    size="small"
                  />

                  <Avatar
                    v-else
                    icon="pi pi-user text-white text-xs"
                    size="small"
                    shape="circle"
                    class="bg-[#1B4D3E]"
                  />
                  <span class="font-bold text-sm"
                    >{{ author.firstName }} {{ author.lastName }}</span
                  >
                  <div class="w-1 h-1 bg-green-700 rounded-full"></div>
                </div>
              </div>

              <div class="flex items-start text-gray-500 gap-2">
                <span class="pi pi-plus text-sm"> </span>
                <span class="font-semibold text-xs w-[11rem]">
                  Find writers to follow.
                </span>
              </div>

              <router-link>
                <Button
                  label="See suggestions"
                  severity="secondary"
                  variant="text"
                  class="text-xs font-semibold"
                  rounded
                />
              </router-link>
            </div>
          </div>
        </ScrollPanel>
      </div>
    </div>
  </div>
</template>

<script setup>
import { ref, onMounted, computed } from "vue";
import Menu from "primevue/menu";
import {
  getAuthorById,
  getFollowedAuthors,
  followAuthor,
  getAuthorInterestedArticles,
  unfollowAuthor,
  getRecommendedTopic,
  getAuthorReadingList,
  addToReadingList,
  removeFromReadingList,
  getRecommendedAuthors,
  getArticleById,
} from "@/assets/js/service";

import { userStore, articleStore } from "@/stores";

import InfiniteLoading from "v3-infinite-loading";
import {
  attachArticleImage,
  handleImage,
  handleDateFormat,
  truncateText,
} from "@/assets/js/util";

const params = computed(() => ({
  start: 0,
  limit: 10,
  status: "published",
}));

const blocked = ref(false);

const articlesFeed = ref([]);
const totalRecords = ref();
const id = localStorage.getItem("app-author-id");
const user = ref("");

const load = async ($state) => {
  console.log("loading...");

  try {
    params.value.start += 10;
    // const result = await getArticles(params.value);

    const result = await getAuthorInterestedArticles(id, params.value);

    if (result.data) {
      if (result.data.length) {
        const { total, values: articles } = result.data;
        const articleWithImage = await attachArticleImage(articles);
        articlesFeed.value.push(
          ...(await attachAuthorToArticles(articleWithImage))
        );
        totalRecords.value = total;
        await handleArticleAuthorFollowers(id, articlesFeed.value);
        $state.loaded();
      } else {
        $state.complete();
      }
    } else {
      console.error("Failed to fetch articles:", result.error);
    }
  } catch (error) {
    console.log({ error });
    $state.error();
  }
};

const fetchArticles = async () => {
  const result = await getAuthorInterestedArticles(user.value.id, params.value);

  if (result.data) {
    const { total, values: articles } = result.data;

    const articleWithImage = await attachArticleImage(articles);

    articlesFeed.value = await attachAuthorToArticles(articleWithImage);

    await handleArticleAuthorFollowers(articlesFeed.value);
    await handleSavedArticles(articlesFeed.value);

    totalRecords.value = total;
  } else {
    console.error("Failed to fetch articles:", result.error);
  }
};

const attachAuthorToArticles = (articles) => {
  return Promise.all(
    articles.map(async (article) => {
      const { data: author } = await getAuthorById(article.authorID);

      author.image = await handleImage(article.authorID);
      article = { author, ...article };
      return article;
    })
  );
};

const menu = ref(null);

const items = ref([
  {
    label: "Refresh",
    icon: "pi pi-refresh",
  },
  {
    label: "Search",
    icon: "pi pi-search",
  },
  {
    separator: true,
  },
  {
    label: "Delete",
    icon: "pi pi-times",
  },
]);

const toggle = (event) => {
  menu.value.toggle(event);
};

const handleArticleAuthorFollowers = async (articles) => {
  try {
    // Update articles' author.isFollowed flag
    for (const article of articles) {
      article.author.isFollowed = await attachAuthorFollowers(
        article.author.id
      );
    }
  } catch (error) {
    console.error("Failed to fetch followed authors:", error);
  }
};

const attachAuthorFollowers = async (userId) => {
  const { data: followedAuthors = [] } = await getFollowedAuthors(userId);

  if (!followedAuthors.length) return false;

  // Create a Set for faster lookups
  const followedAuthorIds = new Set(
    followedAuthors
      .filter((author) => author.id !== userId)
      .map((author) => author.id)
  );

  return followedAuthorIds.has(userId);
};

const handleSavedArticles = async (articles) => {
  try {
    const currentUserId = user.value.id;

    const { data: readingList = [] } = await getAuthorReadingList(
      currentUserId
    );

    if (!readingList.values.length) return;

    // Create a Set for faster lookups
    const readingListAuthorIds = new Set(
      readingList.values
        .filter((list) => list.authorId === currentUserId)
        .map((list) => list.articleId)
    );

    fetchReadingListArticles(readingList);

    // Update articles' author.isSaved flag
    articles.forEach((article) => {
      article.isSaved = readingListAuthorIds.has(article.id);
    });
  } catch (error) {
    console.error("Failed to fetch followed authors:", error);
  }
};

const addAuthorFollower = async (author) => {
  const follower = user.value?.id;

  if (follower === author?.id) return;

  const { data: followedAuthors } = await followAuthor(follower, author?.id);

  if (followedAuthors) author.isFollowed = true;
};

const removeAuthorFollower = async (author) => {
  const follower = user.value?.id;

  if (follower === author?.id) return;

  const { data: followedAuthors } = await unfollowAuthor(follower, author?.id);

  if (followedAuthors) author.isFollowed = false;
};

const addArticleToReadingList = async (articleIdentifier) => {
  const currentUserId = user.value.id;

  const { data: newReadingListItem } = await addToReadingList(
    currentUserId,
    articleIdentifier
  );

  const targetArticle = articlesFeed.value.find(
    (article) => article.id === newReadingListItem.articleId
  );

  if (targetArticle) {
    targetArticle.isSaved = true;
  }
};

const removeArticleFromReadingList = async (articleIdentifier) => {
  const currentUserId = user.value.id;

  const { data: removedReadingListItem } = await removeFromReadingList(
    currentUserId,
    articleIdentifier
  );

  console.log({ removedReadingListItem });

  const targetArticle = articlesFeed.value.find(
    (article) => article.id === removedReadingListItem.articleId
  );

  if (targetArticle) {
    targetArticle.isSaved = false;
  }
};

const totalRecommendedTopics = ref(0);
const recommendedTopics = ref([]);
const fetchRecommendedTopics = async () => {
  const currentUserId = user.value.id;

  const { data: fetchedTopics } = await getRecommendedTopic(currentUserId, 8);
  totalRecommendedTopics.value = fetchedTopics.length;
  recommendedTopics.value = fetchedTopics;
};

const totalRecommendedAuthors = ref(0);
const recommendedAuthors = ref([]);
const fetchRecommendedAuthors = async () => {
  const currentUserId = user.value.id;

  const { data: fetchedAuthors } = await getRecommendedAuthors(
    currentUserId,
    5
  );

  for (const author of fetchedAuthors) {
    author.image = await handleImage(author.id);
    author.isFollowed = await attachAuthorFollowers(author.id);
  }

  totalRecommendedAuthors.value = fetchedAuthors.length;
  recommendedAuthors.value = fetchedAuthors.slice(0, 3);
};

const userReadingList = ref([]);
const totalReadingList = ref(0);
const fetchReadingListArticles = async (articles) => {
  const readingListArticles = await Promise.all(
    articles.values.map((article) => getArticleById(article.articleId))
  );

  totalReadingList.value = articles.total;

  const readingList = readingListArticles.map((list) => list.data).slice(0, 4);
  userReadingList.value = await attachAuthorToArticles(readingList);
};

const followedAuthors = ref([]);
const fetchFollowedAuthors = async () => {
  const currentUserId = user.value.id;

  const { data: authors = [] } = await getFollowedAuthors(currentUserId);

  if (!authors.length) return false;

  for (const author of authors) {
    author.image = await handleImage(author.id);
  }

  followedAuthors.value = authors.slice(0, 10);
};

onMounted(async () => {
  const { getUser } = userStore();
  user.value = await getUser();
  await fetchArticles();
  await fetchRecommendedTopics();
  await fetchRecommendedAuthors();
  await fetchFollowedAuthors();
});

const handleArticleStore = (data) => {
  const { setArticle } = articleStore();
  setArticle(data);
};
</script>
